# [Live Demo](https://guarded-eyrie-72660.herokuapp.com/)

## Concept

A simple user-friendly web-app which accepts a link to a main .m3u8 manifest file, the link of a separate .m3u8 manifest file to be insterted in to the first and an insertion point, generating a link to a new .m3u8 manifest file incorporating the insertion ready for copy-pasting in to a video player.

## Pseudo-code

- Receive form content on `POST`
- Validate and sanitise form content
- Hand parameters to `HLSSpliceVod` to generate content of new manifest
- Format content for new manifest file
  - Insert absolute links to main content
- Write to new file in the cloud (Github)
- Return file URI to user

## Issues / Questions

_(As issues mostly arrive from questions I have yet to answer, they are presented together)_

### `${manifestUrl}/${relativeTsFilePath}` doesn't always find .ts files

I would assume that the file path of the .ts files of the main content in the manifest generated by `HLSSpliceVod` is relative to the manifest file path, which is to say using the file found at:

```
https://maitv-vod.lab.eyevinn.technology/stswe17-ozer.mp4/master.m3u8
```

The references within the generated manifest at such as:

```
#EXTINF:10.8800,
2000-00000.ts // this
```

Would refer to a file found at:

```
https://maitv-vod.lab.eyevinn.technology/stswe17-ozer.mp4/2000-00000.ts
```

But this fails. It can, however, found at:

<pre>
https://maitv-vod.lab.eyevinn.technology/stswe17-ozer.mp4/<b>2000</b>/2000-00000.ts
</pre>

Therefore, to adhere to my concept, I currently have to use ugly string manipulation to insert `/2000/` between the permalink to the .mp4 file and the .ts file relative path, rendering the splicer useless for all other source manifests.

I couldn't find many active free HLS VOD test streams, but to use for example the following [parkour](https://bitdash-a.akamaihd.net/content/MI201109210084_1/m3u8s/f08e80da-bf1d-4e3d-8899-f0f6155f6efa.m3u8) link:

```
https://bitdash-a.akamaihd.net/content/MI201109210084_1/m3u8s/f08e80da-bf1d-4e3d-8899-f0f6155f6efa.m3u8
```

Whose original manifest instructs to look at:

```
../video/720-2400000/hls/segment_0.ts
```

The .ts files can indeed be found at:

```
https://bitdash-a.akamaihd.net/content/MI201109210084_1/m3u8s/../video/720-2400000/hls/segment_0.ts
// resolves to:
// https://bitdash-a.akamaihd.net/content/MI201109210084_1/video/720-2400000/hls/segment_0.ts
```

> Do the relative paths of the .ts files in the .m3u8 file resolve to the same location as the .m3u8 file itself, and if so, why can't the .ts files be found for the link to the Streaming Tech Sweden talk without looking in folder '2000'?

### Streams with separately declared audio manifests lack audio

Going back to the parkour .m3u8, I notice that it contains a link to a separate audio manifest unlike the .m3u8 files provided by Eyevinn:

```
#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="audio",NAME="English stereo",LANGUAGE="en",AUTOSELECT=YES,URI="f08e80da-bf1d-4e3d-8899-f0f6155f6efa_audio_1_stereo_128000.m3u8"
```

If I pass this link as the first parameter in to `HLSSpliceVod`, no reference to the link is found in the output and as such the video loads without audio:

```
#EXTM3U
#EXT-X-VERSION:3
#EXT-X-MEDIA-SEQUENCE:0
#EXT-X-TARGETDURATION:11
#EXT-X-PLAYLIST-TYPE:VOD
#EXTINF:4.0000,
https://bitdash-a.akamaihd.net/content/MI201109210084_1/m3u8s/../video/720_2400000/hls/segment_0.ts
// etc.
```

> Is the lack of audio related to the omission of the audio manifest, and if so, is there an argument or method on `HLSSpliceVod` to catch separately declared audio manifests?

### Using some manifest files results in `this.playlist` on the `HLSSpliceVod` instantiation never being assigned

Using the content provided from the exercise brief as the main content in to which the ad must be inserted:

```
https://maitv-vod.lab.eyevinn.technology/VINN.mp4/master.m3u8
```

I get the following error:

```
    this.playlists[bw].set('playlistType', "VOD"); // Ensure playlist type is VOD
                       ^

TypeError: Cannot read property 'set' of undefined
    at HLSSpliceVod.getMediaManifest (/home/daoud/Documents/Eyevinn/hls-splice-daoud/node_modules/@eyevinn/hls-splice/index.js:244:24)
```

I can't grasp everything going on in the `HLSSpliceVod` library, but having a look I can see that when `load()` is called:

```js
// line 72
const mediaManifestUrl = url.resolve(baseUrl, streamItem.get("uri"));
// 'baseUrl' being the original URL passed to the class instantiation
mediaManifestPromises.push(
  this._loadMediaManifest(
    mediaManifestUrl,
    streamItem.get("bandwidth"),
    _injectMediaManifest
  )
);
```

Then, in `_loadMediaManifest` called above:

```js
// line 252
parser.on('m3u', m3u => {
this.duration = 0;
if (!this.playlists[bandwidth]) {
    this.playlists[bandwidth] = m3u;
}
// function continues
```

Not understanding what the `m3u` generated by the parser is, I can't trace the exact point at which `this.playlists` isn't being correctly assigned and is causing the `undefined` error when `getMediaManifests` attempts to call the `.set` method of `this.playlists[bw]`.

> How and when is `this.playlists` being incorrectly assigned using the VINN.mp4 manifest?
